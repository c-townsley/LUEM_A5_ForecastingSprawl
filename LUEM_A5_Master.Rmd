---
title: "LUEM A5 - Forecasting Sprawl"
author: "Lindsey Hover & Charlie Townsley"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
rm(list=ls())

options(scipen = 999) #turn off scientific notation
#install.packages("FNN")
#install.packages("ggrepel")
#install.packages("yardstick")
#install.packages("igraph")
#install.packages("caret")
#update.packages("caret")

```

```{r libraries and themes}
library(tidyverse)
library(sf)
library(raster)
library(knitr)
library(kableExtra)
library(tidycensus)
library(tigris)
library(FNN)
library(caret)
library(yardstick)
library(pscl)
library(plotROC) 
library(ggrepel)
library(pROC)
library(grid)
library(gridExtra)
library(viridis)
library(igraph)

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  #panel.border=element_rect(colour="#F0F0F0"),
  # Format the grid
  panel.grid.major=element_line(colour="#D0D0D0",size=.75),
  axis.ticks=element_blank())

mapTheme <- theme(plot.title =element_text(size=12),
                  plot.subtitle = element_text(size=8),
                  plot.caption = element_text(size = 6),
                  axis.line=element_blank(),
                  axis.text.x=element_blank(),
                  axis.text.y=element_blank(),
                  axis.ticks=element_blank(),
                  axis.title.x=element_blank(),
                  axis.title.y=element_blank(),
                  panel.background=element_blank(),
                  panel.border=element_blank(),
                  panel.grid.major=element_line(colour = 'transparent'),
                  panel.grid.minor=element_blank(),
                  legend.direction = "vertical", 
                  legend.position = "right",
                  plot.margin = margin(1, 1, 1, 1, 'cm'),
                  legend.key.height = unit(1, "cm"), legend.key.width = unit(0.2, "cm"))

palette2 <- c("#41b6c4","#253494")
palette4 <- c("#a1dab4","#41b6c4","#2c7fb8","#253494")
palette5 <- c("#ffffcc","#a1dab4","#41b6c4","#2c7fb8","#253494")
palette10 <- c("#f7fcf0","#e0f3db","#ccebc5","#a8ddb5","#7bccc4",
               "#4eb3d3","#2b8cbe","#0868ac","#084081","#f7fcf0")
```

```{r functions}
#this function converts a column in to quintiles. It is used for mapping.
quintileBreaks <- function(df,variable) {
    as.character(quantile(df[[variable]],
                          c(.01,.2,.4,.6,.8),na.rm=T))
}

#This function can be used to convert a polygon sf to centroids xy coords.
xyC <- function(aPolygonSF) {
  as.data.frame(
    cbind(x=st_coordinates(st_centroid(aPolygonSF))[,1],
          y=st_coordinates(st_centroid(aPolygonSF))[,2]))
} 

#this function convert a raster to a data frame so it can be plotted in ggplot
rast <- function(inRaster) {
  data.frame(
    xyFromCell(inRaster, 1:ncell(inRaster)), 
    value = getValues(inRaster)) }
```


# Introduction!

Region of interest: Atlanta, GA metro

Years of study: 2008-2019

Projecting to 2029

Data level: Census tract

**Steps**
1. Wrangle data for time period 1 land use, infrastructure, census etc.  
2. Wrangle same data for time period 2  
3. ID areas of land use change period 1 -> period 2  
4. Use period 1 data to create a model ("the model") to predict land use change  
5. Feed period 2 data to the model to project for period 3 in the context of scenarios specified in the assignment  

<br>

# Data Gathering and Feature Engineering

```{r creating GeoJSON from Shapefile, include=FALSE, eval=FALSE}

library(sf)
#SHP1 <- st_read("C:/Users/Lindsey/Desktop/CPLN675_Land_Use_Modeling_Desktop/Final/LUEM_A5_Repo/Shapefiles/SHP1.shp")

#GeoJSON1 <- st_write(SHP1, "C:/Users/Lindsey/Desktop/CPLN675_Land_Use_Modeling_Desktop/Final/LUEM_A5_Repo/GeoJSONs/SHP1.geojson")

#GeoJSON_x <- st_read("https://raw.githubusercontent.com/c-townsley/LUEM_A5_Repo/d9859fc1069dd89d44fcaf345e722a9bf601a550/Data/geojson/GeoJSON_x.geojson") ### specify the file name (note: this is the permalink, but you change the domain to raw.githubusercontent.com AND you remove /blob/)


#Atlanta_metro_bounday <- st_read("https://raw.githubusercontent.com/c-townsley/LUEM_A5_Repo/d9859fc1069dd89d44fcaf345e722a9bf601a550/Data/geojson/Atlanta_Metro_Boundary.geojson")

```

Pull the Atlanta MSA boundary with the `tigris` package.

```{r Atlanta MSA shapefile}
#List of the Atlanta region MPOs 21 counties
Counties <- c("Barrow", "Bartow", "Carroll", "Cherokee", 
              "Clayton", "Cobb", "Coweta", "Dawson", 
              "DeKalb", "Douglas", "Fayette", "Forsyth", 
              "Fulton", "Gwinnett", "Hall", "Henry", 
              "Newton", "Paulding", "Rockdale", "Spalding", "Walton")

#First pull all MSAs in the U.S., then search for yours and filter with the correct CBSAFP code
metro_counties <- counties(state = "GA", cb = TRUE, resolution = "500k", year = NULL) %>%
  filter(NAME %in% Counties) %>% 
  st_transform("ESRI:102267")

#plot MSA boundary to make sure its right
ggplot(metro_counties) + 
  geom_sf() + 
  theme_bw() + 
  labs(title = "Atlanta 21 County MSA")
```


```{r msa conversion, include=FALSE, eval=FALSE}
#Convert shapefile to geojson so can store on github
st_write(metro_counties, append = FALSE, "C:/Users/ctown/OneDrive - PennO365/Classes/Classes_Sem4_2023Spring/CPLN 675_Land Modeling/Assignments/A5_SprawlForecasting/LUEM_A5_Repo/Data/geojson/Atlanta_Metro_Counties.geojson")

st_write(metro_counties, append = FALSE, "C:/Users/ctown/OneDrive - PennO365/Classes/Classes_Sem4_2023Spring/CPLN 675_Land Modeling/Assignments/A5_SprawlForecasting/LUEM_A5_Repo/Data/shapefile/Atlanta_Metro_Boundary/Atlanta_Metro_Counties.shp")
```


Create a fishnet of the Atlanta metro using 2000'x2000' cells.

```{r fishnet}
AtlantaMSA_fishnet <- 
  st_make_grid(metro_counties, cellsize = 2000, square = FALSE) %>%
  st_sf()

AtlantaMSA_fishnet <-
  AtlantaMSA_fishnet[metro_counties,]

#plot MSA boundary to make sure its right
ggplot()+
  geom_sf(data = AtlantaMSA_fishnet,
          fill = "lightgrey") +
  geom_sf(data = metro_counties, 
          color = "black", fill = "transparent") +
  labs(title = "Atlanta MSA Fishnet") +
  mapTheme
```


## Landcover
### Land Cover Individual Years

```{r Import Land Cover data}
lc_2008 = raster("https://raw.githubusercontent.com/c-townsley/LUEM_A5_Repo/cfd6db18d222958b58a1d9169fe261fd5578d277/Data/raster/2008LC.tif")

lc_2019 = raster("https://raw.githubusercontent.com/c-townsley/LUEM_A5_Repo/cfd6db18d222958b58a1d9169fe261fd5578d277/Data/raster/2019LC.tif")

```

```{r Plot land cover for 2008 and 2019}
### This works but does not visualize correctly

grid.arrange(ncol = 2,
ggplot() +
   geom_sf(data = metro_counties, 
          color = "black", fill = "transparent") +
  geom_raster(data=rast(lc_2008) %>% na.omit %>% filter(value > 0), 
              aes(x,y,fill=as.factor(value))) +
  scale_fill_viridis(discrete=TRUE, name ="") +
  labs(title = "Land Cover, 2008") +
  mapTheme +
  theme(legend.direction="horizontal"),

ggplot() +
   geom_sf(data = metro_counties, 
          color = "black", fill = "transparent") +
  geom_raster(data=rast(lc_2019) %>% na.omit %>% filter(value > 0), 
              aes(x,y,fill=as.factor(value))) +
  scale_fill_viridis(discrete=TRUE, name ="") +
  labs(title = "Land Cover, 2019") +
  mapTheme +
  theme(legend.direction="horizontal")
)

```

```{r setup Land Cover}
### I think this works but I am concerned that the lc_2019 overwrites the lc_2008...not sure yet

developed <- lc_2008 == 21 | lc_2008 == 22 | lc_2008 == 23 | lc_2008 == 24
forest <- lc_2008 == 41 | lc_2008 == 42 | lc_2008 == 43 
farm <- lc_2008 == 81 | lc_2008 == 82 
wetlands <- lc_2008 == 90 | lc_2008 == 95 
otherUndeveloped <- lc_2008 == 52 | lc_2008 == 71 | lc_2008 == 31 
water <- lc_2008 == 11

developed <- lc_2019 == 21 | lc_2019 == 22 | lc_2019 == 23 | lc_2019 == 24
forest <- lc_2019 == 41 | lc_2019 == 42 | lc_2019 == 43 
farm <- lc_2019 == 81 | lc_2019 == 82 
wetlands <- lc_2019 == 90 | lc_2019 == 95 
otherUndeveloped <- lc_2019 == 52 | lc_2019 == 71 | lc_2019 == 31 
water <- lc_2019 == 11

developed <- lc_2008 == 21 | lc_2008 == 22 | lc_2008 == 23 | lc_2008 == 24
forest <- lc_2008 == 41 | lc_2008 == 42 | lc_2008 == 43 
farm <- lc_2008 == 81 | lc_2008 == 82 
wetlands <- lc_2008 == 90 | lc_2008 == 95 
otherUndeveloped <- lc_2008 == 52 | lc_2008 == 71 | lc_2008 == 31 
water <- lc_2008 == 11

developed <- lc_2019 == 21 | lc_2019 == 22 | lc_2019 == 23 | lc_2019 == 24
forest <- lc_2019 == 41 | lc_2019 == 42 | lc_2019 == 43 
farm <- lc_2019 == 81 | lc_2019 == 82 
wetlands <- lc_2019 == 90 | lc_2019 == 95 
otherUndeveloped <- lc_2019 == 52 | lc_2019 == 71 | lc_2019 == 31 
water <- lc_2019 == 11

names(developed) <- "developed"
names(forest) <- "forest"
names(farm) <- "farm"
names(wetlands) <- "wetlands"
names(otherUndeveloped) <- "otherUndeveloped"
names(water) <- "water"
```   

```{r}

theRasterList <- c(developed,forest,farm,wetlands,otherUndeveloped,water)

### This part has a dataframe issue
aggregatedRasters <-
  aggregateRaster(theRasterList, AtlantaMSA_fishnet) %>%
  dplyr::select(developed,forest,farm,wetlands,otherUndeveloped,water) %>%
  mutate_if(is.numeric,as.factor)

aggregatedRasters %>%
  gather(var,value,developed:water) %>%
  st_cast("POLYGON") %>%    #just to make sure no weird geometries slipped in
  mutate(X = xyC(.)$x,
         Y = xyC(.)$y) %>%
  ggplot() +
    geom_sf(data=houstonMSA) +
    geom_point(aes(X,Y, colour=as.factor(value))) +
    facet_wrap(~var) +
    scale_colour_manual(values = palette2,
                        labels=c("Other","Land Cover"),
                        name = "") +
    labs(title = "Land Cover Types, 2001",
         subtitle = "As fishnet centroids") +
   mapTheme
```


```{r create Aggregate raster}
### This is just pasted from the markdown.

aggregateRaster <- function(inputRasterList, theFishnet) {
  #create an empty fishnet with the same dimensions as the input fishnet
  theseFishnets <- theFishnet %>% dplyr::select()
  #for each raster in the raster list
  for (i in inputRasterList) {
  #create a variable name corresponding to the ith raster
  varName <- names(i)
  #convert raster to points as an sf
    thesePoints <-
      rasterToPoints(i) %>%
      as.data.frame() %>%
      st_as_sf(coords = c("x", "y"), crs = st_crs(theFishnet)) %>%
      filter(.[[1]] == 1)
  #aggregate to the fishnet
    thisFishnet <-
      aggregate(thesePoints, theFishnet, length) %>%
      mutate(!!varName := ifelse(is.na(.[[1]]),0,1))
  #add to the larger fishnet
    theseFishnets <- cbind(theseFishnets,thisFishnet)
  }
  #output all aggregates as one large fishnet
   return(theseFishnets)
  }
 

```


### Land Cover Change

```{r define Reclassify Matrix}
### Should work to set up reclassify matrix

reclassMatrix <- 
  matrix(c(
    0,12,0,
    12,24,1,
    24,Inf,0),
  ncol=3, byrow=T)

reclassMatrix

```

```{r}
### should work

lc_2008r <- 
  reclassify(lc_2008,reclassMatrix)

lc_2008r[lc_2008r < 1] <- NA

names(lc_2008r) <- "lc_change08"


lc_2019r <- 
  reclassify(lc_2019,reclassMatrix)

lc_2019r[lc_2019r < 1] <- NA

names(lc_2019r) <- "lc_change19"

ggplot() +
  geom_sf(data=AtlantaMSA_fishnet) +
  geom_raster(data=rast(lc_2008r) %>% na.omit, 
              aes(x,y,fill=as.factor(value))) +
  scale_fill_viridis(discrete=TRUE, name ="Land Cover\nChange") + 
  labs(title="Development Land Use Change") +
  mapTheme


```


```{r converting fishnet to centroids}

### Not sure yet if this works lol

changePoints <-
  rasterToPoints(lc_2008r) %>%
  as.data.frame() %>%
  st_as_sf(coords = c("x", "y"), crs = st_crs(AtlantaMSA_fishnet))

fishnet <- 
  aggregate(changePoints, AtlantaMSA_fishnet, sum) %>%
  mutate(lc_2008r = ifelse(is.na(lc_2008r),0,1),
         lc_2008r = as.factor(lc_2008r))

ggplot() +
  geom_sf(data = metro_boundary) +
  geom_point(data = AtlantaMSA_fishnet, 
             aes(x=xyC(AtlantaMSA_fishnet)$x, y=xyC(AtlantaMSA_fishnet)$y, colour=lc_2008r)) +
  scale_colour_manual(values = palette2,
                      labels=c("No Change","New Development"),
                      name = "") +
  labs(title = "Land Cover Development Change", subtitle = "As fishnet centroids") +
  mapTheme



```




## Land Use


## Census Data: Population

Download population data for 2009.

```{r metro pop 2009}
# Look here for variable codes
acs_vars <- load_variables(2009, "acs5")

#Pull 2009 population
Pop09 <- 
  get_acs(geography = "tract", variables = "B01003_001", year = 2009,
                state = 13, geometry = TRUE, 
                county = Counties) %>%
  rename("pop09" = estimate) %>% 
  st_transform(st_crs(AtlantaMSA_fishnet))
```

Download population data for 2019.

```{r metro pop 2019}
#Pull 2019 population
Pop19 <- 
  get_acs(geography = "tract", variables = "B01003_001", year = 2019,
                state = 13, geometry = TRUE, 
                county = Counties) %>%
  rename("pop19" = estimate) %>% 
  st_transform(st_crs(AtlantaMSA_fishnet)) %>% 
  st_buffer(-1) #buffer the the tracts by -1ft. This is done because tidycensus appears to return geometries that are problematic when subjected to the area weighted interpolation function
```


```{r plot both pop years, fig.width=8}
grid.arrange(
ggplot() +
  geom_sf(data = Pop09, aes(fill=factor(ntile(pop09,5))), colour=NA) +
  scale_fill_manual(values = palette5,
                    labels=quintileBreaks(Pop09,"pop09"),
                   name="Quintile\nBreaks") +
  labs(title="2009 Population\nAtlanta 21-County MSA") +
  mapTheme,

ggplot() +
  geom_sf(data = Pop19, aes(fill=factor(ntile(pop19,5))), colour=NA) +
  scale_fill_manual(values = palette5,
                    labels=quintileBreaks(Pop19,"pop19"),
                   name="Quintile\nBreaks") +
  labs(title="2019 Population\nAtlanta 21-County MSA") +
  mapTheme, ncol=2)
```

Reconcile tract boundaries and fishnet grid cells

```{r reconcile tracts and fishnet cells}
AtlantaMSA_fishnet <-
  AtlantaMSA_fishnet %>%
  rownames_to_column("fishnetID") %>% 
  mutate(fishnetID = as.numeric(fishnetID)) %>%
  dplyr::select(fishnetID)

fishnetPop09 <-
  st_interpolate_aw(Pop09["pop09"], AtlantaMSA_fishnet, extensive=TRUE) %>%
  as.data.frame(.) %>%
  rownames_to_column(var = "fishnetID") %>%
  left_join(AtlantaMSA_fishnet %>%
              mutate(fishnetID = as.character(fishnetID)),
            ., by=c("fishnetID"='fishnetID')) %>% 
  mutate(pop09 = replace_na(pop09,0)) %>%
  dplyr::select(pop09)

fishnetPop19 <-
  st_interpolate_aw(Pop19["pop19"], AtlantaMSA_fishnet, extensive=TRUE) %>%
  as.data.frame(.) %>%
  rownames_to_column(var = "fishnetID") %>%
  left_join(AtlantaMSA_fishnet %>%
              mutate(fishnetID = as.character(fishnetID)),
            ., by=c("fishnetID"='fishnetID')) %>% 
  mutate(pop19 = replace_na(pop19,0)) %>%
  dplyr::select(pop19)

fishnetPop <- 
  cbind(fishnetPop09, fishnetPop19) %>%
  dplyr::select(pop09,pop19) %>%
  mutate(pop_Change = pop19 - pop09)
```

Compare population by tract vs pop by grid cell

```{r plot pop tract and grid cell}
grid.arrange(
ggplot() +
  geom_sf(data=Pop19, aes(fill=factor(ntile(pop19,5))),colour=NA) +
  scale_fill_manual(values = palette5,
                    labels=substr(quintileBreaks(Pop19,"pop19"),1,4),
                   name="Quintile\nBreaks") +
  labs(title="2019 Population\nAtlanta 21-County MSA",
       subtitle="Represented as tracts; Boundaries omitted") +
  mapTheme,

ggplot() +
  geom_sf(data=fishnetPop, aes(fill=factor(ntile(pop19,5))), colour=NA) +
  scale_fill_manual(values = palette5,
                   labels=substr(quintileBreaks(fishnetPop,"pop19"),1,4),
                   name="Quintile\nBreaks") +
  labs(title="2019 Population\nAtlanta 21-County MSA",
       subtitle="Represented as fishnet gridcells; Boundaries omitted") +
  mapTheme, ncol=2)
```

## Highway Distance

Load in highway data.

```{r highway to geojson, include=FALSE, eval=FALSE}
metro_highways <- st_read("C:/Users/ctown/OneDrive - PennO365/Classes/Classes_Sem4_2023Spring/CPLN 675_Land Modeling/Assignments/A5_SprawlForecasting/LUEM_A5_Repo/Data/shapefile/AtlantaMetro_Major_Roads/Major_Roads.shp")

st_write(metro_highways, append = FALSE, "C:/Users/ctown/OneDrive - PennO365/Classes/Classes_Sem4_2023Spring/CPLN 675_Land Modeling/Assignments/A5_SprawlForecasting/LUEM_A5_Repo/Data/geojson/Major_Roads.geojson")
```


```{r highways}
AtlantaHighways <-
  st_read("https://raw.githubusercontent.com/c-townsley/LUEM_A5_Repo/8b689651286bb4ff28554095bd39ce1bd87655e4/Data/geojson/Major_Roads.geojson") %>%
  st_transform(st_crs(metro_counties)) %>%
  st_intersection(metro_counties) %>% 
  filter(FEATURE_TY == "State Highway")

#INCLUDE NEW DEVELOPMENT IN PLOT ONCE THAT CODE IS WRITTEN
ggplot() +
  geom_sf(data=metro_counties) +
  geom_sf(data=AtlantaHighways) +
  labs(title = "Highways") +
  mapTheme
```



## Development

<br>

# Data Exploration

## ID areas of land use change period 1 -> period 2  

<br>

# Model Building: Binary Logistic Regression

Use period 1 data to create a model ("the model") to predict land use change

# Model Testing and Validation

# Planning Scenarios (Projections)

## Scenario 1: Supply-side Change Forecast

>From Assignment:
>In this scenario, you will “plan” a new large-scale development, like a new highway or public transportation line. Your model will probably use transit proximity as a predictor of land use change – what happens when you make new infrastructure and then predict the location of new development?

>Draw this new development in ArcGIS or the mapedit package (if it requires new infrastructure) and you will briefly describe the nature of this new development (What is it? What kind of new demand do you expect it to generate?). Please be creative in how you design/describe your intervention.

>After drawing the new development, come up with a scenario-based population projection for that area and create a development forecast for 2029.


## Scenario 2: Demand-side Change Forecast

>From Assignment:
>Demand-side change: In this scenario, you will find or approximate 2029 population projections for your study area and then ‘distribute’ the ‘new’ population among all the census tracts in the region according to a logic or plan that you devise[4].
You will use your population forecast and 2019 data to predict where new development will occur in 2029. Metropolitan planning organizations (MPOs) publish population forecasts for metro areas. If you can’t find one for your area, make some reasonable projection of your own and note that you have done so.





